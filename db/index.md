# 数据库索引设计与优化

## 不合适的索引

不合适的所以是性能低下的最常见原因。最普遍的问题似乎是没有索引足够多的列来支持where自居中的所有谓词。包括，表上没有足够多的索引，一些select语句可能没有有效的索引，有时索引上包含了正确的列，但列的顺序却不对。

## 表和索引结构

### 索引页和表页

表和索引行都是被存储在页中，页大小一般为4KB，页的大小仅仅决定了一个页可以存储多少索引行，表行，以及一共需要多少页来存储表或者索引。

### 索引行

一个索引行等同于叶子页中的一个索引条目，字段的值从表中复制到索引上，并加上一个指向表中记录的指针，对于非唯一索引，每个索引条目后面都有多个指针

### 索引结构

索引通常以B树实现，其中非叶子页通常包含着键值，以及一个指向下一层级页的指针，该键值是下一层级页中的最大键值，多个索引层级按照这一方式逐层建立，直到只剩下一个页，这被称作根页

### 表行

每个索引行都指向表中相对应的一行记录，指针通常标识了记录所存放的页及它在页中的位置。当加载表或者向表中插入记录的时候，表中记录的顺序可以被定义成和它的某一个索引记录相同的顺序（对表建立索引，并按索引来访问），这种情况下，当所索引行被按顺序处理时，对应的表行也将依照相同的顺序被逐个处理，索引和表都按相同的顺序被访问，这是一个效率很高的处理过程。

索引已经关联的表行，及如果我们按照索引去访问表记录，实际上是走的按索引去访问表记录，以查询为例，按索引去查询某些记录，实际上我们是通过索引访问（B树遍历）效率是远大于顺序访问整个表的。

### 缓冲池和磁盘I/O

关系型数据库管理系统提供了缓存池的概念来最小化磁盘I/O。索引或表页在或不在缓冲池中，访问的成本是不同的。

所以当一个索引或表页被请求时，它的理想位置是在数据库缓冲池，如果它不再那儿，那么下一个最佳的位置实在磁盘服务器的读缓冲区中，如果它也不在那儿，那么就必须从磁盘进行一次很慢的读取，这一过程可能要花费很长的时间等待磁盘设备空闲下来。

从DBMS缓冲池进行读取到了索引或表页，那么唯一的成本就是去处理这些索引或者表记录。

顺序读取优于随机读，顺序读取的两个优势：

* 同时读取多个页意味着平均读取每个页的时间将会减少
* 由于DBMS事先直到需要读取哪些页，所以可以在页被真正请求之前就提前将其读取进来，即预读

辅助式随机读，数据库或者系统提供的用于优化随机读取的方式：

1. 自动跳跃式顺序读，如果不连续的行被按照同一个方向扫描，那么访问模式将会是跳跃式顺序的。带来的好处类似顺序读
2. 列表预读，在表和索引行顺序不一致的情况下，主动创造跳跃式顺序访问，即访问所有满足条件的索引行，在按照表行的顺序排序后再访问表行，DB2
3. 数据块预读，从索引片上搜集指针，然后再进行多重随机I/O来并行的读取表行，Oracle

### DBMS特性

1. 页，表页的大小限定了表行的最大长度，
2. 表聚簇，
3. 索引行，
4. 表行，
5. 索引组织表，
6. 页邻接

### B树索引的替代品

1. 位图索引
2. 散列
3. 聚簇索引

## SQL处理过程

 